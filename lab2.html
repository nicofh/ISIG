<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
        <link rel="stylesheet" href="https://js.arcgis.com/4.5/esri/css/main.css">
        <script src="https://js.arcgis.com/4.5/"></script>
        <link rel="stylesheet" href="css/styles.css">
        <link rel="stylesheet" href="css/bootstrap.css">

        <title>Obligatorio2-ISIG2017</title>

        <script type="text/javascript">
          var numParada=0;
           require([
          "esri/Map",
          "esri/views/MapView",
          "dojo/dom",
           "dojo/on",
           "esri/layers/TileLayer",

           "esri/symbols/PictureMarkerSymbol",
           "esri/renderers/SimpleRenderer",
           "esri/layers/GraphicsLayer",
           "esri/Graphic",
           "esri/geometry/support/webMercatorUtils",
           "esri/tasks/Locator",
           "esri/widgets/Search",
            "esri/tasks/RouteTask",
            "esri/tasks/support/RouteParameters",
            "esri/tasks/support/FeatureSet",
            "esri/core/urlUtils",
             "esri/symbols/SimpleLineSymbol",
             "esri/Color",
            "esri/layers/FeatureLayer",
            "esri/tasks/QueryTask",
             "esri/tasks/support/Query",




           "dojo/domReady!"




        ], function(Map,MapView,dom,on,TileLayer,PictureMarkerSymbol,SimpleRenderer,GraphicsLayer,Graphic,webMercatorUtils,Locator,Search,RouteTask,
            RouteParameters,FeatureSet,urlUtils,SimpleLineSymbol,Color,FeatureLayer,QueryTask,Query) {


          urlUtils.addProxyRule({
              urlPrefix: "route.arcgis.com",
              proxyUrl: "http://localhost:8080/proxy/proxy.jsp"
            });

          var map = new Map({
            basemap: "streets",


          });

          var view = new MapView({
            container: "viewDiv",  // Reference to the DOM node that will contain the view
            map: map,               // References the map object created in step 3
            center: [-94.4035, 39.802],
            zoom: 4
          });



          //buttons
          on(dom.byId("generarRuta"), "click", generarRuta);
          on(dom.byId("guardarRuta"), "click", guardarRuta);
          on(dom.byId("limpiarTodo"), "click", limpiarTodo);


          var layer = new TileLayer("http://services.arcgisonline.com/arcgis/rest/services/World_Street_Map/MapServer");
          map.layers.add(layer);

          view.then( function(event){
            //view.on('click',addStop);
          });
          view.on('click',addStop);

          //variables
          var tablaParadas = [];

          //SIMBOLOS
          var stopSymbol = new PictureMarkerSymbol('http://static.arcgis.com/images/Symbols/Basic/LightBlueShinyPin.png',51,51);


          //CAPAS
            //Capa de paradas
           // var capaParadas = new GraphicsLayer();
            //var paradaRender = SimpleRenderer(stopSymbol);
            //capaParadas.setRenderer(paradaRender);
           // map.layers.add(capaParadas);


            //Capa de Eventos
            var capaParadas = new FeatureLayer("http://sampleserver5.arcgisonline.com/arcgis/rest/services/LocalGovernment/Events/FeatureServer/0",{
            mode: esri.layers.FeatureLayer.MODE_ONDEMAND,
            outFields: ["*"],
            opacity: 0.9
            });
            capaParadas.spatialReference=map.spatialReference;
            capaParadas.setDefinitionExpression("description='grupo3'"); //elegimos que eventos mostrar
            map.layers.add(capaParadas);






          //STOPS

          //traduce nombre a coordenadas
           var locator = new Locator("http://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer");

          var locationPoint;
          function addStop(evt) {
            console.log(evt.mapPoint)
            locationPoint = new Graphic(evt.mapPoint, stopSymbol);
            capaParadas.graphics.add(locationPoint)
            var result = locator.locationToAddress(webMercatorUtils.webMercatorToGeographic(evt.mapPoint), 100);
            result.then(function(addressCandidate){
                console.log(addressCandidate.address, addressCandidate.location.latitude, addressCandidate.location.longitude)
                tablaParadas.push({"address" :addressCandidate.address,"latitude":addressCandidate.location.latitude, "longitude":addressCandidate.location.longitude}) ;

                console.log("tabla",tablaParadas)
                var list = document.getElementById('rutaList');
                var nuevoItem = document.createElement('li');
                nuevoItem.setAttribute('draggable','true');
                nuevoItem.ondblclick = function() {sacarParada(this);}
                nuevoItem.appendChild(document.createTextNode( '-      '+addressCandidate.address));
                list.appendChild(nuevoItem);
                $("#rutaList").sortable('refresh');
            })

          }

          function sacarParada(parada){
            var lugarRemovido = parada.innerHTML;
            for(var j=0; j< tablaParadas.length; j++){
              var elem=lugarRemovido.replace('-      ','');
              if (elem === tablaParadas[j].address){
                console.log("true",capaParadas.graphics.items[j])
                capaParadas.graphics.remove(capaParadas.graphics.items[j])
                tablaParadas.splice(j,1);
                numParada--;
              }
            }
            console.log(tablaParadas)
            parada.parentNode.removeChild(parada);
          }







          // RUTAS

          //Rutas Layer

          //Capa de Rutas
          var capaRutas = new GraphicsLayer();
            //var paradaRender = SimpleRenderer(stopSymbol);
            //capaParadas.setRenderer(paradaRender);
            map.layers.add(capaRutas);

          //ruta layer service
          var rutaLayerService = new FeatureLayer("http://sampleserver5.arcgisonline.com/arcgis/rest/services/LocalGovernment/Recreation/FeatureServer/1",{
            mode: FeatureLayer.MODE_ONDEMAND,
            outFields: ["*"]
          });
          rutaLayerService.spatialReference = map.spatialReference;

          var rutaActual;
          var routeSymbol = new SimpleLineSymbol();

          var routeTask = new RouteTask("http://route.arcgis.com/arcgis/rest/services/World/Route/NAServer/Route_World/");
          var routeParams = new RouteParameters();
          routeParams.stops = new FeatureSet();
          routeParams.outSpatialReference = {"wkid":102100};



          function guardarRuta(){
            console.log(rutaActual)
            var rutaGuardada = new Graphic(rutaActual.items[0].geometry, null,null);
            var nombreRuta = $('#routeName').val();
            rutaGuardada.setAttribute("trailtype",2);
            rutaGuardada.setAttribute("condition",2);
            rutaGuardada.setAttribute("difficulty",1);
            rutaGuardada.setAttribute("notes", nombreRuta)
            var date =new Date("July 19, 1950 11:13:00");
            rutaGuardada.setAttribute("recordedon",19061950)
            rutaLayerService.applyEdits({addFeatures:[rutaGuardada]}).then(function(data){
              console.log(data);
              cargarRutas();
            });

          }

          function generarRuta(){ //resuelve la ruta
            capaRutas.graphics.removeAll();

            console.log(routeParams.stops)
            if(routeParams.stops.features.length>0){
              routeParams.stops.features=[];
            }
            //tener en cuenta q cuando genera ruta tiene que seguir el orden de la rutalist del html, ya que ahi esta el orden
            //en que se quiere obtener los puntos de la ruta.
            var stops = document.getElementById('rutaList').getElementsByTagName('li');
            var lugar;
            console.log(stops)
            for (var i=0; i < stops.length; i++){
              lugar = stops[i].innerHTML;
              console.log(lugar)
              for(var j=0; j< tablaParadas.length; j++){
                console.log()
                if (lugar.replace('-      ','') == tablaParadas[j].address){
                  routeParams.stops.features.push(capaParadas.graphics.items[j]);
                }
              }
            }

            if(routeParams.stops.features.length>=2){
                routeTask.solve(routeParams).then(mostrarRuta)

            }
          }

          function mostrarRuta(data){
              var routeResult = data.routeResults[0].route;
              routeResult.symbol = routeSymbol;
              console.log(routeResult)
              rutaActual= capaRutas.graphics.add(routeResult);

          }


          function limpiarTodo(){
            for (var i=routeParams.stops.features.length-1; i>=0; i--) {
              capaParadas.graphics.remove(routeParams.stops.features.splice(i, 1)[0]);
            }
            tablaParadas = [];
            capaParadas.graphics.removeAll();
            capaRutas.graphics.removeAll();

            $('#rutaList').empty();
            $("#rutaList").sortable('refresh');

          }


          function cargarRutas(){

            $("#selRutas").empty();
            var queryTask = new QueryTask("http://sampleserver5.arcgisonline.com/arcgis/rest/services/LocalGovernment/Recreation/FeatureServer/1");
            query = new Query();
            query.outFields = ["*"];
            var date=new Date("July 19, 1950 11:13:00");
            query.where = "recordedon = 19062000";
            query.returnGeometry = false;
            queryTask.execute(query).then(function(res){
                                        console.log(res)
                                        var select = document.getElementById("selRutas");
                                        for ( i=0 ;i < res.features.length; i++){
                                          var option = document.createElement('option');
                                          option.text = option.value = res.features[i].attributes.notes;
                                          select.add(option, 0);
                                        }
                                       })

          }


          $(function() {
                cargarRutas();
            });









          // SEARCH
          var searchWidget = new Search({
            view: view
          });
          // Adds the search widget below other elements in
          // the top left corner of the view
          view.ui.add(searchWidget, {
            position: "top-right",
            index: 2
          });


          var sources = [
            {
              locator: new Locator({ url: "//geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer" }),
              singleLineFieldName: "SingleLine",
              outFields: ["Addr_type"],
              localSearchOptions: {
                minScale: 300000,
                distance: 50000
              },
              resultSymbol: {
                     type: "picture-marker",  // autocasts as new PictureMarkerSymbol()

                     size: 0,
                     width: 0,
                     height: 0,
                     xoffset: 0,
                     yoffset: 0
                 }
                          }
          ];

          searchWidget.sources = sources;



          searchWidget.on("search-complete", function(event){
            // The results are stored in the event Object[]

            var coordenadas = event.results[0].results[0].feature.geometry;
            locationPoint = new Graphic(coordenadas, stopSymbol);
            capaParadas.graphics.add(locationPoint);
            tablaParadas.push({"address" :event.searchTerm,"latitude":coordenadas.latitude, "longitude":coordenadas.longitude}) ;
            var list = document.getElementById('rutaList');
            var nuevoItem = document.createElement('li');
            nuevoItem.setAttribute('draggable','true');
            nuevoItem.ondblclick = function() {sacarParada(this);}
            nuevoItem.appendChild(document.createTextNode( '-      '+event.searchTerm));
            list.appendChild(nuevoItem);
            $("#rutaList").sortable('refresh');
          });




        });







        </script>

    </head>

    <body>

          <div class="row">

            <!--Barra lateral-->
            <div class="col-md-3 ">

                <ul class="nav nav-pills" style="background-color:#d4d4d4">
                  <li class="active" style="padding-left:10px"><a data-toggle="pill" href="#home">Inicio</a></li>
                  <li><a data-toggle="pill" href="#menu1">Simulacion</a></li>

                </ul>

                 <div class="tab-content" style="margin-left:20px">
                    <!--Menu Home-->
                    <div id="home" class="tab-pane fade in active" >
                       <input id="routeName"  style="width: 150px;background-color:transparent;
                                                      border-color:transparent; font-size:20px; margin-top:20px;
                                                      margin-left:10px"
                              placeholder="Nombre Ruta..."


                        ></input>

                       <ul id="rutaList"  class="sortable list li-sort"  style="margin-left:10px; width:80%; padding:0px" >
                       </ul>

                       <button  id="generarRuta" class="btn btn-primary bttons" style="margin-left:10px">Generar Ruta</button>
                       <button  id="guardarRuta" class="btn btn-primary bttons" style="margin-left:10px">Guardar Ruta</button>

                      <br>
                      <br>
                      <div style="margin-left:10px">
                       <h4> Seleccionar Ruta</h4>
                       <select id="selRutas" name="selectRutas" style="width: 80%; border-radius:8px; background-color:rgba(243, 243, 243, 0.93) !important" ></select>
                      </div>

                      <div style="margin-top:30px">
                          <button  id="limpiarTodo" class="btn btn-primary bttons" style="margin-left:10px">Limpiar Todo</button>

                       </div>
                    </div>
                  </div>


            </div>

            <!--Seccion del mapa-->
            <div class="col-md-9" style="background-color:#e7eff1 !important">
              <!-- <input id="routeName" style="border-radius: 10px;float:right;margin-right: 20px;border-width: 1px;margin-top: 5px;margin-bottom: 5px ; height:5% "  placeholder="Write location..."> </input> -->

              <!--map div-->
              <div id="viewDiv"  ></div>
            </div>
            <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
            <script src="js/jquery.sortable.js"></script>




          </body>



    </body>
</html>