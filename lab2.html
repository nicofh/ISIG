<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
        <link rel="stylesheet" href="https://js.arcgis.com/4.5/esri/css/main.css">
        <script src="https://js.arcgis.com/4.5/"></script>
        <link rel="stylesheet" href="css/styles.css">
        <link rel="stylesheet" href="css/bootstrap.css">

        <title>Obligatorio2-ISIG2017</title>

        <script type="text/javascript">
          var numParada=0;
           require([
          "esri/Map",
          "esri/views/MapView",
          "dojo/dom",
           "dojo/on",
           "esri/layers/TileLayer",

           "esri/symbols/PictureMarkerSymbol",
           "esri/renderers/SimpleRenderer",
           "esri/layers/GraphicsLayer",
           "esri/Graphic",
           "esri/geometry/support/webMercatorUtils",
           "esri/tasks/Locator",


           "dojo/domReady!"




        ], function(Map,MapView,dom,on,TileLayer,PictureMarkerSymbol,SimpleRenderer,GraphicsLayer,Graphic,webMercatorUtils,Locator) {
          var map = new Map({
            basemap: "streets",


          });

          var view = new MapView({
            container: "viewDiv",  // Reference to the DOM node that will contain the view
            map: map,               // References the map object created in step 3
            center: [-94.4035, 39.802],
            zoom: 4
          });

          var layer = new TileLayer("http://services.arcgisonline.com/arcgis/rest/services/World_Street_Map/MapServer");
          map.layers.add(layer);

          view.then( function(event){
            //view.on('click',addStop);
          });
          view.on('click',addStop);

          //variables
          var tablaParadas = [];

          //SIMBOLOS
          var stopSymbol = new PictureMarkerSymbol('http://static.arcgis.com/images/Symbols/Basic/LightBlueShinyPin.png',51,51);


          //CAPAS
            //Capa de paradas
            var capaParadas = new GraphicsLayer();
            //var paradaRender = SimpleRenderer(stopSymbol);
            //capaParadas.setRenderer(paradaRender);
            map.layers.add(capaParadas);








          //STOPS

          //traduce nombre a coordenadas
           var locator = new Locator("http://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer");

          var locationPoint;
          function addStop(evt) {
            console.log(evt.mapPoint)
            locationPoint = new Graphic(evt.mapPoint, stopSymbol);
            capaParadas.graphics.add(locationPoint)
            var result = locator.locationToAddress(webMercatorUtils.webMercatorToGeographic(evt.mapPoint), 100);
            result.then(function(addressCandidate){
                console.log(addressCandidate.address, addressCandidate.location.latitude, addressCandidate.location.longitude)
                tablaParadas.push({"address" :addressCandidate.address,"latitude":addressCandidate.location.latitude, "longitude":addressCandidate.location.longitude}) ;

                console.log("tabla",tablaParadas)
                var list = document.getElementById('rutaList');
                var nuevoItem = document.createElement('li');
                nuevoItem.setAttribute('draggable','true');
                nuevoItem.ondblclick = function() {sacarParada(this);}
                nuevoItem.appendChild(document.createTextNode( '-      '+addressCandidate.address));
                list.appendChild(nuevoItem);
                $("#rutaList").sortable('refresh');
            })

          }

          function sacarParada(parada){
            var lugarRemovido = parada.innerHTML;
            for(var j=0; j< tablaParadas.length; j++){
              var elem=lugarRemovido.replace('-      ','');
              if (elem === tablaParadas[j].address){
                console.log("true",capaParadas.graphics.items[j])
                capaParadas.graphics.remove(capaParadas.graphics.items[j])
                tablaParadas.splice(j,1);
                numParada--;
              }
            }
            console.log(tablaParadas)
            parada.parentNode.removeChild(parada);
          }





          // RUTAS
          function guardarRuta(){

          }

          function generarRuta(){
            //tener en cuenta q cuando genera ruta tiene que seguir el orden de la rutalist del html, ya que ahi esta el orden
            //en que se quiere obtener los puntos de la ruta.
          }






        });







        </script>

    </head>

    <body>

          <div class="row">

            <!--Barra lateral-->
            <div class="col-md-3 ">

                <ul class="nav nav-pills" style="background-color:#d4d4d4">
                  <li class="active" style="padding-left:10px"><a data-toggle="pill" href="#home">Inicio</a></li>
                  <li><a data-toggle="pill" href="#menu1">Simulacion</a></li>

                </ul>

                 <div class="tab-content" style="margin-left:20px">
                    <!--Menu Home-->
                    <div id="home" class="tab-pane fade in active" >
                       <h4>&nbsp Ruta</h4>
                       <ul id="rutaList"  class="sortable list li-sort"  style="margin-left:10px; width:80%; padding:0px" >
                       </ul>

                       <button  id="generarRuta" class="btn btn-primary bttons" style="margin-left:10px">Generar Ruta</button>
                       <button  onClick="guardarRuta()" class="btn btn-primary bttons" style="margin-left:10px">Guardar Ruta</button>

                      <br>
                      <br>
                      <div style="margin-left:10px">
                       <h4> Seleccionar Ruta</h4>
                       <select id="selRutas" name="selectRutas" style="width: 80%; border-radius:8px; background-color:rgba(243, 243, 243, 0.93) !important" ></select>
                      </div>

                    </div>
                  </div>


            </div>

            <!--Seccion del mapa-->
            <div class="col-md-9" style="background-color:#e7eff1 !important">
              <input id="routeName" style="border-radius: 10px;float:right;margin-right: 20px;border-width: 1px;margin-top: 5px;margin-bottom: 5px ; height:5% "  placeholder="Write location..."> </input>

              <!--map div-->
              <div id="viewDiv"  ></div>
            </div>
            <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
            <script src="js/jquery.sortable.js"></script>




          </body>



    </body>
</html>